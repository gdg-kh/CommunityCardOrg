<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1200, initial-scale=1.0">
    <title>{{YEAR}} 年 {{MONTH}} 月高雄社群活動月曆</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            width: 1200px;
            height: 630px;
            font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif;
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .og-container {
            width: 100%;
            height: 100%;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        .og-header {
            text-align: center;
            margin-bottom: 12px;
        }

        .og-title {
            font-size: 28px;
            font-weight: bold;
            color: #333;
        }

        .calendar-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: #f8f9fa;
            border-radius: 8px 8px 0 0;
            text-align: center;
            font-weight: bold;
            padding: 8px 0;
            font-size: 15px;
            color: #495057;
        }

        .calendar-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-auto-rows: 1fr;
            gap: 1px;
            background: #ddd;
            border-radius: 0 0 8px 8px;
            overflow: hidden;
        }

        .calendar-day {
            background: white;
            padding: 8px 8px 0 8px;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .calendar-day.empty {
            background: #fcfcfc;
        }

        /* Weekend borders */
        .calendar-day.saturday {
            border-left: 2px solid #f28b82;
            border-right: 2px solid #f28b82;
            border-bottom: 2px solid #f28b82;
        }

        .calendar-day.sunday {
            border-left: 2px solid #f28b82;
            border-right: 2px solid #f28b82;
            border-bottom: 2px solid #f28b82;
        }

        /* Add top border only when needed */
        .calendar-day.saturday.weekend-top,
        .calendar-day.sunday.weekend-top {
            border-top: 2px solid #f28b82;
        }

        /* Remove duplicate border between Saturday and Sunday */
        .calendar-day.saturday + .calendar-day.sunday {
            border-left: none;
        }

        .date-number {
            font-weight: bold;
            font-size: 18px;
            color: #333;
            margin-bottom: 4px;
            flex-shrink: 0;
        }

        .day-event {
            font-size: 11px;
            line-height: 1.3;
            border-left: 3px solid #0d6efd;
            padding-left: 4px;
            margin-bottom: 3px;
            overflow: hidden;
        }

        .event-community {
            font-weight: bold;
            margin-bottom: 1px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .event-name {
            color: #333;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

    </style>
</head>
<body>
    <div class="og-container">
        <div class="og-header">
            <div class="og-title">{{YEAR}} 年 {{MONTH}} 月高雄社群活動</div>
        </div>

        <div class="calendar-wrapper">
            <div class="calendar-header">
                <div>週一</div>
                <div>週二</div>
                <div>週三</div>
                <div>週四</div>
                <div>週五</div>
                <div>週六</div>
                <div>週日</div>
            </div>
            <div id="calendar-grid" class="calendar-grid">
                <!-- JavaScript will inject calendar cells here -->
            </div>
        </div>
    </div>

    <script>
        // Injected data
        const year = {{YEAR}};
        const month = {{MONTH}};
        const events = {{EVENTS_JSON}};

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            const firstDay = new Date(year, month - 1, 1);
            let startDay = firstDay.getDay();
            startDay = (startDay === 0) ? 6 : startDay - 1;

            const daysInMonth = new Date(year, month, 0).getDate();
            let html = '';

            // Empty cells before start
            for (let i = 0; i < startDay; i++) {
                html += '<div class="calendar-day empty"></div>';
            }

            // Days
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

                // Calculate day of week (0=Sunday, 6=Saturday)
                const currentDateObj = new Date(year, month - 1, day);
                const dayOfWeek = currentDateObj.getDay();
                const isSaturday = (dayOfWeek === 6);
                const isSunday = (dayOfWeek === 0);
                const isWeekend = isSaturday || isSunday;

                // Check if we need top border
                let needTopBorder = false;
                if (isWeekend) {
                    if (day <= 7) {
                        needTopBorder = true;
                    } else {
                        const prevWeekDay = day - 7;
                        const prevWeekDate = new Date(year, month - 1, prevWeekDay);
                        const prevWeekDayOfWeek = prevWeekDate.getDay();
                        const prevWeekIsWeekend = (prevWeekDayOfWeek === 0 || prevWeekDayOfWeek === 6);
                        needTopBorder = !prevWeekIsWeekend;
                    }
                }

                const weekendClass = isSaturday ? ' saturday' : (isSunday ? ' sunday' : '');
                const topBorderClass = needTopBorder ? ' weekend-top' : '';

                const dayEvents = events.filter(e => e.date === dateStr);

                html += `<div class="calendar-day${weekendClass}${topBorderClass}">
                    <div class="date-number">${day}</div>`;

                // If 2+ events on same day, only show community name
                const showTitleOnly = dayEvents.length >= 2;

                dayEvents.forEach(event => {
                    const colorStyle = event.color ? `color: ${event.color};` : '';
                    const borderStyle = event.color ? `border-left-color: ${event.color};` : '';
                    const hasTitle = event.title && event.title.trim();

                    html += `<div class="day-event" style="${borderStyle}">
                        <div class="event-community" style="${colorStyle}">${event.community}</div>
                        ${(!showTitleOnly && hasTitle) ? `<div class="event-name">${event.title}</div>` : ''}
                    </div>`;
                });

                html += '</div>';
            }

            // Fill remaining grid
            const totalCells = startDay + daysInMonth;
            const remaining = 7 - (totalCells % 7);
            if (remaining < 7) {
                for (let i = 0; i < remaining; i++) {
                    html += '<div class="calendar-day empty"></div>';
                }
            }

            grid.innerHTML = html;
        }

        // Execute rendering
        renderCalendar();
    </script>
</body>
</html>
